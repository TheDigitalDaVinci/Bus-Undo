<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUS UNDO - ബസ് സമയം (Google Sheets Edition)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .hover-lift:hover {
            transform: translateY(-3px);
        }
        .loading-spinner {
            border: 4px solid #f3f3f5;
            border-left: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen p-4">
    <!-- Setup Instructions Modal -->
    <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl max-h-screen overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-cog mr-2"></i>Google Sheets Setup Required
                </h2>
                <button onclick="closeSetupModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-sm">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <p class="font-semibold text-yellow-800">⚠️ Setup Required Before Using</p>
                    <p class="text-yellow-700">This app needs Google Apps Script setup to work with Google Sheets.</p>
                </div>

                <div class="space-y-3">
                    <h3 class="font-bold text-lg">Step 1: Create Google Apps Script Project</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4">
                        <li>Go to <a href="https://script.google.com" target="_blank" class="text-blue-600 underline">script.google.com</a></li>
                        <li>Click "New Project"</li>
                        <li>Replace the default code with the provided Apps Script code</li>
                        <li>Save the project (name it "Bus Undo Backend")</li>
                    </ol>

                    <h3 class="font-bold text-lg">Step 2: Deploy as Web App</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4">
                        <li>Click "Deploy" → "New deployment"</li>
                        <li>Choose "Web app" as the type</li>
                        <li>Set "Execute as" to "Me"</li>
                        <li>Set "Who has access" to "Anyone"</li>
                        <li>Click "Deploy" and copy the Web App URL</li>
                    </ol>

                    <h3 class="font-bold text-lg">Step 3: Configure This App</h3>
                    <p>Paste your Google Apps Script Web App URL below:</p>
                    <input type="url" id="webAppUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" 
                           class="w-full p-3 border rounded-lg">
                    <button onclick="saveWebAppUrl()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Save URL & Continue
                    </button>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-bold mb-2">Google Apps Script Code (Copy this):</h4>
                    <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-xs overflow-x-auto"><code>// Google Apps Script Code for Bus Undo Backend
function doPost(e) {
  const sheet = getOrCreateSheet();
  const data = JSON.parse(e.postData.contents);
  
  if (data.action === 'addBus') {
    const row = [
      new Date().toISOString(),
      data.from,
      data.to,
      data.name,
      data.time,
      0, // initial verifications
      data.userId,
      'active'
    ];
    sheet.appendRow(row);
    return ContentService.createTextOutput(JSON.stringify({success: true, message: 'Bus added successfully'}))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  if (data.action === 'verifyBus') {
    const values = sheet.getDataRange().getValues();
    for (let i = 1; i < values.length; i++) {
      if (values[i][0] && values[i][0].toISOString() === data.busId) {
        sheet.getRange(i + 1, 6).setValue(values[i][5] + 1);
        break;
      }
    }
    return ContentService.createTextOutput(JSON.stringify({success: true}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  const sheet = getOrCreateSheet();
  const data = sheet.getDataRange().getValues();
  
  if (data.length <= 1) {
    return ContentService.createTextOutput(JSON.stringify({buses: []}))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  const buses = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][7] === 'active') {
      buses.push({
        id: data[i][0].toISOString(),
        from: data[i][1],
        to: data[i][2],
        name: data[i][3],
        time: data[i][4],
        verifications: data[i][5] || 0,
        addedBy: data[i][6],
        dateAdded: data[i][0]
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({buses: buses}))
    .setMimeType(ContentService.MimeType.JSON);
}

function getOrCreateSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet() || SpreadsheetApp.create('Bus Undo Database');
  let sheet = ss.getSheetByName('BusData');
  
  if (!sheet) {
    sheet = ss.insertSheet('BusData');
    sheet.getRange(1, 1, 1, 8).setValues([
      ['Date Added', 'From', 'To', 'Bus Name', 'Time', 'Verifications', 'Added By', 'Status']
    ]);
  }
  
  return sheet;
}</code></pre>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-t-xl p-8 text-center card-shadow">
            <h1 class="text-4xl font-bold mb-2">
                <i class="fas fa-bus mr-3"></i>BUS UNDO
            </h1>
            <p class="text-xl opacity-90 mb-4">ബസ് ഉണ്ടോ? - അവിടെ ഇപ്പോൾ ബസ് ഉണ്ടോ?</p>
            <div id="currentTime" class="bg-white bg-opacity-20 px-6 py-2 rounded-full inline-block font-bold"></div>
            <div class="mt-2 text-sm opacity-75">
                <i class="fas fa-cloud mr-1"></i>Data synced with Google Sheets
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-b-xl card-shadow">
            <!-- Connection Status -->
            <div id="connectionStatus" class="px-8 py-4 border-b">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div id="statusIndicator" class="w-3 h-3 rounded-full mr-2"></div>
                        <span id="statusText" class="text-sm font-medium"></span>
                    </div>
                    <button onclick="showSetupModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-cog mr-1"></i>Setup
                    </button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="p-8">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-map-marker-alt mr-2"></i>നിങ്ങൾ ഇപ്പോൾ എവിടെയാണ്? (Where are you now?)
                        </label>
                        <input type="text" id="fromLocation" 
                               placeholder="ഉദാ: കൊച്ചി (e.g., Kochi)"
                               class="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-map-marker-alt mr-2"></i>എവിടെ പോകണം? (Where do you want to go?)
                        </label>
                        <input type="text" id="toLocation" 
                               placeholder="ഉദാ: തിരുവനന്തപുരം (e.g., Thiruvananthapuram)"
                               class="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors">
                    </div>
                </div>

                <button onclick="searchBuses()" 
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-105">
                    <i class="fas fa-search mr-2"></i>ബസ് തിരയുക (Search Buses)
                </button>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden px-8 pb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-list mr-2"></i>ലഭ്യമായ ബസുകൾ (Available Buses)
                </h2>
                <div id="busResults"></div>
            </div>

            <!-- Add Bus Section -->
            <div class="bg-gray-50 p-8 border-t">
                <h3 class="text-xl font-bold text-center mb-6">
                    <i class="fas fa-plus-circle mr-2"></i>പുതിയ ബസ് വിവരങ്ങൾ ചേർക്കുക (Add New Bus Information)
                </h3>
                
                <div id="addBusSuccess" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-4">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span id="successMessage"></span>
                </div>

                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">എവിടെ നിന്ന് (From)</label>
                        <input type="text" id="newBusFrom" 
                               placeholder="ഉദാ: കൊച്ചി"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">എവിടേക്ക് (To)</label>
                        <input type="text" id="newBusTo" 
                               placeholder="ഉദാ: തിരുവനന്തപുരം"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ബസിന്റെ പേര് (Bus Name)</label>
                        <input type="text" id="newBusName" 
                               placeholder="ഉദാ: കെഎസ്ആർടിസി സൂപ്പർ ഫാസ്റ്റ്"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">സമയം (Time)</label>
                        <input type="time" id="newBusTime" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </div>
                </div>

                <button onclick="addNewBus()" 
                        class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-green-700 hover:to-teal-700 transition-all">
                    <i class="fas fa-plus mr-2"></i>ബസ് വിവരങ്ങൾ ചേർക്കുക (Add Bus Information)
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let WEBAPP_URL = localStorage.getItem('webAppUrl') || '';
        let busData = [];
        let userVerifications = JSON.parse(localStorage.getItem('busVerifications') || '{}');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            if (!WEBAPP_URL) {
                showSetupModal();
            } else {
                updateConnectionStatus();
                loadBusData();
            }

            // Auto-fill functionality
            document.getElementById('fromLocation').addEventListener('input', function() {
                document.getElementById('newBusFrom').value = this.value;
            });

            document.getElementById('toLocation').addEventListener('input', function() {
                document.getElementById('newBusTo').value = this.value;
            });
        });

        // Time display
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Kolkata'
            });
            document.getElementById('currentTime').textContent = `ഇപ്പോളത്തെ സമയം: ${timeString}`;
        }

        // Setup Modal Functions
        function showSetupModal() {
            document.getElementById('setupModal').classList.remove('hidden');
            document.getElementById('webAppUrl').value = WEBAPP_URL;
        }

        function closeSetupModal() {
            document.getElementById('setupModal').classList.add('hidden');
        }

        function saveWebAppUrl() {
            const url = document.getElementById('webAppUrl').value.trim();
            if (!url) {
                alert('Please enter the Web App URL');
                return;
            }
            
            WEBAPP_URL = url;
            localStorage.setItem('webAppUrl', url);
            closeSetupModal();
            updateConnectionStatus();
            loadBusData();
        }

        // Connection Status
        function updateConnectionStatus() {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (!WEBAPP_URL) {
                indicator.className = 'w-3 h-3 rounded-full mr-2 bg-red-500';
                text.textContent = 'Not configured - Click Setup';
                return;
            }

            indicator.className = 'w-3 h-3 rounded-full mr-2 bg-yellow-500 pulse-animation';
            text.textContent = 'Connecting to Google Sheets...';

            // Test connection
            fetch(WEBAPP_URL)
                .then(response => response.json())
                .then(data => {
                    indicator.className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
                    text.textContent = 'Connected to Google Sheets';
                })
                .catch(error => {
                    indicator.className = 'w-3 h-3 rounded-full mr-2 bg-red-500';
                    text.textContent = 'Connection failed - Check setup';
                });
        }

        // Data Functions
        async function loadBusData() {
            if (!WEBAPP_URL) return;
            
            try {
                const response = await fetch(WEBAPP_URL);
                const data = await response.json();
                busData = data.buses || [];
            } catch (error) {
                console.error('Error loading bus data:', error);
                showError('Failed to load bus data from Google Sheets');
            }
        }

        async function searchBuses() {
            const fromLocation = document.getElementById('fromLocation').value.trim();
            const toLocation = document.getElementById('toLocation').value.trim();

            if (!fromLocation || !toLocation) {
                alert('ദയവായി രണ്ട് സ്ഥലങ്ങളും നൽകുക (Please enter both locations)');
                return;
            }

            if (!WEBAPP_URL) {
                showSetupModal();
                return;
            }

            const resultsSection = document.getElementById('resultsSection');
            const busResults = document.getElementById('busResults');
            
            resultsSection.classList.remove('hidden');
            busResults.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="loading-spinner mr-4"></div>
                    <span class="text-gray-600">🔍 ബസുകൾ തിരയുന്നു... (Searching for buses...)</span>
                </div>
            `;

            try {
                await loadBusData();
                displayResults(fromLocation, toLocation);
            } catch (error) {
                busResults.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                        <p>Error loading data from Google Sheets</p>
                        <p class="text-sm mt-2">Please check your internet connection and setup</p>
                    </div>
                `;
            }
        }

        function displayResults(fromLocation, toLocation) {
            const busResults = document.getElementById('busResults');
            const currentTime = new Date();
            
            const matchingBuses = busData.filter(bus => {
                const busTime = new Date();
                const [hours, minutes] = bus.time.split(':');
                busTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                return (
                    bus.from.toLowerCase().includes(fromLocation.toLowerCase()) &&
                    bus.to.toLowerCase().includes(toLocation.toLowerCase()) &&
                    busTime >= currentTime
                );
            });

            matchingBuses.sort((a, b) => a.time.localeCompare(b.time));
            const earliestBuses = matchingBuses.slice(0, 5);

            if (earliestBuses.length === 0) {
                busResults.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-bus text-4xl text-gray-400 mb-4"></i>
                        <p class="text-lg text-gray-600 mb-2">😔 ${fromLocation} മുതൽ ${toLocation} വരെ ഇപ്പോൾ ബസുകൾ ലഭ്യമല്ല</p>
                        <p class="text-gray-500 mb-4">(No buses available from ${fromLocation} to ${toLocation} at this time)</p>
                        <p class="text-sm text-gray-600">പുതിയ ബസ് വിവരങ്ങൾ ചേർക്കാൻ താഴെയുള്ള ഫോം ഉപയോഗിക്കുക</p>
                        <p class="text-sm text-gray-500">(Use the form below to add new bus information)</p>
                    </div>
                `;
                return;
            }

            let resultsHTML = '';
            earliestBuses.forEach(bus => {
                const canVerify = canUserVerify(bus.id);
                const buttonText = canVerify ? 'സ്ഥിരീകരിക്കുക' : 'സ്ഥിരീകരിച്ചു';
                
                resultsHTML += `
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-6 mb-4 hover-lift transition-all">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                            <div class="mb-2 md:mb-0">
                                <h3 class="text-xl font-bold text-gray-800">${bus.name}</h3>
                                <p class="text-gray-600">
                                    <i class="fas fa-route mr-1"></i>${bus.from} → ${bus.to}
                                </p>
                            </div>
                            <div class="text-2xl font-bold text-blue-600">
                                <i class="fas fa-clock mr-1"></i>${bus.time}
                            </div>
                        </div>
                        <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                            <div class="text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                ${bus.verifications} പേർ സ്ഥിരീകരിച്ചു (${bus.verifications} people verified)
                            </div>
                            <button onclick="verifyBus('${bus.id}')" 
                                    ${!canVerify ? 'disabled' : ''}
                                    class="px-4 py-2 rounded-lg font-semibold transition-colors ${
                                        canVerify 
                                            ? 'bg-green-600 text-white hover:bg-green-700' 
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }">
                                <i class="fas fa-thumbs-up mr-1"></i>${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            });

            busResults.innerHTML = resultsHTML;
        }

        function canUserVerify(busId) {
            const today = new Date().toDateString();
            const userKey = `bus_${busId}`;
            
            if (!userVerifications[userKey]) {
                return true;
            }
            
            const lastVerificationDate = new Date(userVerifications[userKey]).toDateString();
            return lastVerificationDate !== today;
        }

        async function verifyBus(busId) {
            if (!canUserVerify(busId)) {
                alert('നിങ്ങൾ ഇന്ന് ഈ ബസ് സ്ഥിരീകരിച്ചിട്ടുണ്ട് (You have already verified this bus today)');
                return;
            }

            if (!WEBAPP_URL) {
                showSetupModal();
                return;
            }

            try {
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'verifyBus',
                        busId: busId,
                        userId: getUserId()
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    userVerifications[`bus_${busId}`] = new Date().toISOString();
                    localStorage.setItem('busVerifications', JSON.stringify(userVerifications));
                    
                    // Refresh the results
                    const fromLocation = document.getElementById('fromLocation').value;
                    const toLocation = document.getElementById('toLocation').value;
                    await loadBusData();
                    displayResults(fromLocation, toLocation);
                    
                    alert('നന്ദി! ബസ് സമയം സ്ഥിരീകരിച്ചു (Thank you! Bus timing verified)');
                }
            } catch (error) {
                console.error('Error verifying bus:', error);
                showError('Failed to verify bus timing');
            }
        }

        async function addNewBus() {
            const from = document.getElementById('newBusFrom').value.trim();
            const to = document.getElementById('newBusTo').value.trim();
            const name = document.getElementById('newBusName').value.trim();
            const time = document.getElementById('newBusTime').value;

            if (!from || !to || !name || !time) {
                alert('ദയവായി എല്ലാ വിവരങ്ങളും നൽകുക (Please fill in all information)');
                return;
            }

            if (!WEBAPP_URL) {
                showSetupModal();
                return;
            }

            try {
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addBus',
                        from: from,
                        to: to,
                        name: name,
                        time: time,
                        userId: getUserId()
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Clear form
                    document.getElementById('newBusFrom').value = '';
                    document.getElementById('newBusTo').value = '';
                    document.getElementById('newBusName').value = '';
                    document.getElementById('newBusTime').value = '';

                    // Show success message
                    showSuccess('പുതിയ ബസ് വിവരങ്ങൾ വിജയകരമായി ചേർത്തു! (New bus information added successfully!)');
                    
                    // Reload data
                    await loadBusData();
                    
                    // Refresh results if currently searching
                    const fromLocation = document.getElementById('fromLocation').value;
                    const toLocation = document.getElementById('toLocation').value;
                    if (fromLocation && toLocation) {
                        displayResults(fromLocation, toLocation);
                    }
                } else {
                    throw new Error(result.message || 'Failed to add bus');
                }
            } catch (error) {
                console.error('Error adding bus:', error);
                showError('Failed to add bus information to Google Sheets');
            }
        }

        // Utility Functions
        function getUserId() {
            let userId = localStorage.getItem('busUndoUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('busUndoUserId', userId);
            }
            return userId;
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('addBusSuccess');
            const messageSpan = document.getElementById('successMessage');
            
            messageSpan.textContent = message;
            successDiv.classList.remove('hidden');
            
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 5000);
        }

        function showError(message) {
            alert(`❌ Error: ${message}`);
        }
    </script>
</body>
</html>
